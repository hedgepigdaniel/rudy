{"version":3,"sources":["../../src/core/createRouter.js"],"names":["qs","createSelector","isServer","defaultCreateRestoreScroll","compose","createHistory","createReducer","createInitialState","createRequest","formatRoutes","shouldTransition","parseSearch","onError","defaultOnError","serverRedirect","pathlessRoute","anonymousThunk","transformAction","call","enter","changePageTitle","saveScroll","restoreScroll","routesInput","options","middlewares","location","title","formatRoute","createSmartHistory","createLocationReducer","createState","onErr","scrollRestorerCreator","stringifyQuery","stringify","routes","selectLocationState","history","firstAction","initialState","reducer","wares","register","name","val","has","ctx","busy","api","scrollRestorer","undefined","prev","runOnServer","runOnHydrate","cache","nextPromise","middleware","dispatch","getState","getLocation","s","Object","assign","listen","action","tmp","canceled","Promise","resolve","req","mw","route","next","path","catch","error","wallabyErrors","errorType","type","then","res","clientLoadBusy","isRoutePipeline","firstRoute","resolveOnEnter","resolveFirstRouteOnEnter"],"mappings":"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","sourcesContent":["// @flow\nimport qs from 'qs'\nimport { createSelector, isServer } from '@respond-framework/utils'\nimport defaultCreateRestoreScroll from '@respond-framework/scroll-restorer'\nimport type {\n  Options,\n  Store,\n  Dispatch,\n  RoutesInput,\n  RequestAPI,\n} from '../flow-types'\nimport {\n  compose,\n  createHistory,\n  createReducer,\n  createInitialState,\n  createRequest,\n} from './index'\n\nimport {\n  formatRoutes,\n  shouldTransition,\n  parseSearch,\n  onError as defaultOnError,\n} from '../utils'\n\nimport {\n  serverRedirect,\n  pathlessRoute,\n  anonymousThunk,\n  transformAction,\n  call,\n  enter,\n  changePageTitle,\n  saveScroll,\n  restoreScroll,\n} from '../middleware'\n\nexport default (\n  routesInput: RoutesInput = {},\n  options: Options = {},\n  middlewares: Array<Function>,\n) => {\n  const {\n    location,\n    title,\n    formatRoute,\n    createHistory: createSmartHistory = createHistory,\n    createReducer: createLocationReducer = createReducer,\n    createInitialState: createState = createInitialState,\n    onError: onErr,\n    restoreScroll: scrollRestorerCreator = defaultCreateRestoreScroll(),\n  } = options\n\n  // assign to options so middleware can override them in 1st pass if necessary\n  options.shouldTransition = options.shouldTransition || shouldTransition\n  options.createRequest = options.createRequest || createRequest\n  options.compose = options.compose || compose\n  options.onError = typeof onErr !== 'undefined' ? onErr : defaultOnError\n  options.parseSearch = options.parseSearch || parseSearch\n  options.stringifyQuery = options.stringifyQuery || qs.stringify\n\n  const routes = formatRoutes(routesInput, formatRoute)\n  const selectLocationState = createSelector(\n    'location',\n    location,\n  )\n  const history = createSmartHistory(routes, options)\n  const { firstAction } = history\n  const initialState = createState(firstAction)\n  const reducer = createLocationReducer(initialState, routes)\n  const wares = {}\n  const register = (name: string, val?: any = true) => (wares[name] = val)\n  const has = (name: string) => wares[name]\n  const ctx = { busy: false }\n  const api = { routes, history, options, register, has, ctx }\n\n  const scrollRestorer = isServer() ? undefined : scrollRestorerCreator(api)\n  api.scrollRestorer = scrollRestorer\n\n  if (!middlewares) {\n    middlewares = [\n      serverRedirect, // short-circuiting middleware\n      anonymousThunk,\n      pathlessRoute('thunk'),\n      transformAction, // pipeline starts here\n      // Hydrate: skip callbacks called on server to produce initialState (beforeEnter, thunk, etc)\n      // Server: don't allow client-centric callbacks (onEnter, onLeave, beforeLeave)\n      call('beforeLeave', { prev: true }),\n      call('beforeEnter', { runOnServer: true }),\n      saveScroll,\n      enter,\n      changePageTitle({ title: options.title }),\n      call('onLeave', { prev: true }),\n      call('onEnter', { runOnHydrate: true }),\n      call('thunk', { cache: true, runOnServer: true }),\n      restoreScroll,\n      call('onComplete', { runOnServer: true }),\n    ]\n  }\n  const onError = call('onError', { runOnServer: true, runOnHydrate: true })(\n    api,\n  )\n  const nextPromise = options.compose(\n    middlewares,\n    api,\n    true,\n  )\n\n  const middleware = ({ dispatch, getState }: Store) => {\n    const getLocation = (s) => selectLocationState(s || getState() || {})\n    const { shouldTransition, createRequest } = options // middlewares may mutably monkey-patch these in above call to `compose`\n\n    // TODO: Fix these annotations\n    Object.assign(api, { getLocation, dispatch, getState })\n\n    history.listen(dispatch, getLocation) // dispatch actions in response to pops, use redux location state as single source of truth\n\n    return (dispatch: Dispatch) => (action: Object): Promise<any> => {\n      if (!shouldTransition(action, api)) return dispatch(action) // short-circuit and pass through Redux middleware normally\n      if (action.tmp && action.tmp.canceled) return Promise.resolve(action)\n\n      const req = createRequest(action, api, dispatch) // the `Request` arg passed to all middleware\n      const mw = req.route.middleware\n      const next = mw\n        ? options.compose(\n            mw,\n            api,\n            !!req.route.path,\n          )\n        : nextPromise\n\n      return next(req) // start middleware pipeline\n        .catch((error) => {\n          if (options.wallabyErrors) throw error // wallaby UI is linkable if we don't re-throw errors (we'll see errors for the few tests of errors outside of wallaby)\n          req.error = error\n          req.errorType = `${req.action.type}_ERROR`\n          return onError(req)\n        })\n        .then((res) => {\n          const { route, tmp, ctx, clientLoadBusy } = req\n          const isRoutePipeline = route.path && !tmp.canceled && !clientLoadBusy\n          ctx.busy = isRoutePipeline ? false : ctx.busy\n          return res\n        })\n    }\n  }\n\n  return {\n    api,\n    middleware,\n    reducer,\n    firstRoute: (resolveOnEnter = true) => {\n      api.resolveFirstRouteOnEnter = resolveOnEnter\n      return firstAction\n    },\n  }\n}\n"],"file":"createRouter.js"}